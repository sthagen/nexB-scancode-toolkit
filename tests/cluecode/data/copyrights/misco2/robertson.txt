(Based on code copyright 2007 by Ian Robertson).
